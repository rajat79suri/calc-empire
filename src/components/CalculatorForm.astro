---
interface Props {
    calculator: any;
    currency: string;
}

const { calculator, currency } = Astro.props;
const { logic_type, inputs, extras = [] } = calculator;

const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() + 1;
---

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="bg-white dark:bg-gray-800 p-6 lg:p-8 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 max-w-6xl mx-auto mt-8 grid lg:grid-cols-12 gap-8 print:shadow-none print:border-none print:mt-0 print:block">

{/* LEFT COLUMN: INPUTS */}
<div class="lg:col-span-5 space-y-6 print:hidden">
<div class="flex items-center gap-3 mb-4 border-b border-gray-100 dark:border-gray-700 pb-4">
<span class="text-3xl">{calculator.icon}</span>
<h2 class="text-xl font-bold text-gray-900 dark:text-white">{calculator.title}</h2>
</div>

<form id="calc-form" class="space-y-5" data-logic={logic_type} data-currency={currency}>

{/* SECTION 1: CORE INPUTS */}
{['loan', 'growth'].includes(logic_type) && (
<div class="space-y-4">
<div>
<label class="label">{inputs.p_label}</label>
<div class="relative">
<span class="currency-symbol" data-currency={currency}>{currency}</span>
<input type="text" inputmode="decimal" id="input_p" placeholder="400,000" class="input-field input-with-currency comma-input" required value="400000" />
</div>
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label class="label">{inputs.r_label}</label>
<div class="relative">
<input type="number" id="input_r" placeholder="5.5" step="0.01" class="input-field pr-8" required value="5.5" />
<span class="absolute right-3 top-3 text-gray-400 font-bold">%</span>
</div>
</div>
<div>
<label class="label">{inputs.t_label}</label>
<input type="number" id="input_t" placeholder="30" class="input-field" required value="30" />
</div>
</div>

{/* Custom Date Picker */}
<div>
<label class="label">Start Date</label>
<div class="grid grid-cols-2 gap-2">
<select id="input_month" class="input-field">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
<select id="input_year" class="input-field">
{Array.from({length: 50}, (_, i) => currentYear + i).map(year => (
<option value={year} selected={year === currentYear}>{year}</option>
))}
</select>
</div>
</div>
</div>
)}

{/* SECTION 2: EXTRAS (Toggleable) */}
{extras && extras.length > 0 && (
<div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
<label class="flex items-center gap-2 cursor-pointer mb-4">
<input type="checkbox" id="toggle-extras" class="w-4 h-4 text-blue-600 rounded" checked />
<span class="text-sm font-bold text-gray-700 dark:text-gray-300 select-none">Include Taxes & Fees</span>
</label>

<div id="extras-container" class="grid grid-cols-1 gap-3 transition-all">
{extras.map((field) => (
<div class="grid grid-cols-2 gap-2 items-center">
<label class="text-xs font-semibold text-gray-600 dark:text-gray-400">{field.label}</label>
<div class="relative">
<span class="absolute left-2 top-2 text-gray-400 text-xs">{currency}</span>
<input
type="text"
inputmode="decimal"
id={`extra_${field.id}`}
placeholder={field.default.toLocaleString()}
value={field.default}
class="input-field pl-6 py-1.5 text-sm comma-input"
/>
</div>
</div>
))}
</div>
</div>
)}

{/* Inputs for Simple Calcs */}
{['roi', 'profit', 'simple_diff', 'percentage'].includes(logic_type) && (
<div class="grid grid-cols-1 gap-4">
<div><label class="label">{inputs.c_label || inputs.v1_label}</label><input type="text" inputmode="decimal" id="input_v1" class="input-field comma-input" /></div>
<div><label class="label">{inputs.v_label || inputs.v2_label}</label><input type="text" inputmode="decimal" id="input_v2" class="input-field comma-input" /></div>
</div>
)}

<button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-green-500/30 transform hover:-translate-y-0.5 text-lg flex justify-center items-center gap-2">
<span>Calculate</span> üöÄ
</button>
</form>
</div>

{/* RIGHT COLUMN: DASHBOARD */}
<div class="lg:col-span-7 flex flex-col gap-6 print:col-span-12 print:w-full">

{/* 1. Summary Card */}
<div class="bg-gray-50 dark:bg-gray-900 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm print:bg-white print:border-black">

{/* Placeholder before calculation */}
<div id="results-placeholder" class="text-center py-8">
<div class="text-6xl mb-3 opacity-50">üìä</div>
<p class="text-gray-500 dark:text-gray-400 font-medium">Enter values and click <span class="text-green-600 font-bold">Calculate</span> to see results</p>
</div>

{/* LOAN CALCULATORS: Full breakdown with payoff date */}
{['loan', 'growth'].includes(logic_type) ? (
<>
<div id="results-header" class="hidden border-b border-gray-200 dark:border-gray-700 pb-4 mb-4">
<div class="flex justify-between items-end">
<div>
<p class="text-xs uppercase tracking-widest font-bold text-gray-500" id="result-label">Monthly Payment</p>
<div class="text-5xl font-black text-green-600 dark:text-green-400 tracking-tight mt-1 print:text-black" id="final-result"></div>
</div>
{logic_type === 'loan' && (
<div class="text-right hidden sm:block print:block">
<p class="text-xs font-bold text-gray-400">PAYOFF DATE</p>
<p class="text-xl font-bold text-gray-800 dark:text-white print:text-black" id="res-date"></p>
</div>
)}
</div>
</div>

<div id="results-details" class="hidden">
<div class="grid sm:grid-cols-2 gap-6">
<div class="space-y-2 text-sm">
<div class="flex justify-between"><span class="text-gray-500" id="label-principal">Principal</span><span class="font-bold dark:text-white print:text-black" id="res-loan">--</span></div>
<div class="flex justify-between"><span class="text-gray-500" id="label-interest">Total Interest</span><span class="font-bold text-red-500 print:text-black" id="res-interest">--</span></div>
<div id="row-taxes" class="flex justify-between hidden"><span class="text-gray-500">Total Taxes/Fees</span><span class="font-bold text-orange-500 print:text-black" id="res-tax">--</span></div>
<div class="flex justify-between border-t border-gray-200 pt-2 mt-1"><span class="font-bold text-gray-700 dark:text-gray-300 print:text-black" id="label-total">Total Cost</span><span class="font-bold dark:text-white print:text-black" id="res-total">--</span></div>
</div>
<div class="flex flex-col items-center">
<div class="h-32 w-32 relative">
<canvas id="myChart"></canvas>
</div>
<div id="chart-legend" class="flex flex-wrap justify-center gap-3 mt-3 text-xs"></div>
</div>
</div>
</div>
</>
) : (
<>
{/* SIMPLE CALCULATORS: Just the result */}
<div id="results-header" class="hidden">
<div class="text-center py-4">
<p class="text-xs uppercase tracking-widest font-bold text-gray-500 mb-2" id="result-label">Result</p>
<div class="text-5xl font-black text-green-600 dark:text-green-400 tracking-tight print:text-black" id="final-result"></div>
</div>
</div>
<div id="results-details" class="hidden"></div>
</>
)}

{/* Share Actions (Hidden on Print) */}
<div id="share-actions" class="hidden mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3 print:hidden">
<button id="share-btn" class="flex-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-2 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors flex justify-center items-center gap-2">
üîó Copy Link
</button>
<button id="print-btn-action" class="flex-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-2 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors flex justify-center items-center gap-2">
üñ®Ô∏è Save PDF
</button>
</div>
</div>

{/* üí° SMART ADVISOR - 4 CARDS */}
{logic_type === 'loan' && (
<div id="smart-advisor" class="hidden bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border border-amber-200 dark:border-amber-800/50 rounded-xl p-5 shadow-sm animate-fade-in print:hidden">
<div class="flex items-center gap-2 mb-4">
<span class="text-2xl">üí°</span>
<div>
<h3 class="font-bold text-amber-900 dark:text-amber-100">Smart Savings Recommendations</h3>
<p class="text-xs text-amber-700 dark:text-amber-300">Actionable strategies to save money on your loan</p>
</div>
</div>

{/* 4-Card Grid */}
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="advisor-cards">

{/* Card 1: Extra Payment */}
<div id="card-extra" class="advisor-card bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-transparent hover:border-green-400 transition-all hover:shadow-lg cursor-pointer group">
<div class="flex items-start justify-between mb-2">
<span class="text-2xl">üíµ</span>
<div class="flex items-center gap-1">
<span class="text-[10px] font-bold uppercase px-2 py-0.5 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 rounded-full">Easy Win</span>
<div class="tooltip-container relative">
<span class="tooltip-trigger w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 text-[10px] font-bold flex items-center justify-center cursor-help">?</span>
<div class="tooltip-content absolute right-0 top-6 w-56 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50 opacity-0 invisible transition-all">
<strong>Extra Principal Payments</strong><br/>Adding extra money to your monthly payment goes directly toward your loan principal. This reduces total interest paid and shortens your loan term. Even small extra amounts add up significantly over time.
</div>
</div>
</div>
</div>
<p class="text-xs text-gray-500 font-bold uppercase mb-1">Pay Extra +{currency}100/mo</p>
<p class="text-lg font-black text-green-600 mb-1" id="save-amount-1">--</p>
<p class="text-xs text-gray-500 mb-2">saved in interest</p>
<p class="text-xs text-gray-400" id="save-time-1">Pay off -- years earlier</p>
<div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
<span class="text-xs text-blue-600 font-bold group-hover:underline flex items-center gap-1">See Details <span class="group-hover:translate-x-1 transition-transform">‚Üí</span></span>
</div>
</div>

{/* Card 2: Shorter Term */}
<div id="card-term" class="advisor-card bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-transparent hover:border-blue-400 transition-all hover:shadow-lg cursor-pointer group">
<div class="flex items-start justify-between mb-2">
<span class="text-2xl">üìÖ</span>
<div class="flex items-center gap-1">
<span class="text-[10px] font-bold uppercase px-2 py-0.5 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full">High Impact</span>
<div class="tooltip-container relative">
<span class="tooltip-trigger w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 text-[10px] font-bold flex items-center justify-center cursor-help">?</span>
<div class="tooltip-content absolute right-0 top-6 w-56 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50 opacity-0 invisible transition-all">
<strong>Shorter Loan Term</strong><br/>Choosing a shorter loan term (e.g., 15 years instead of 30) means higher monthly payments but dramatically less total interest. You'll own your home faster and pay tens of thousands less overall.
</div>
</div>
</div>
</div>
<p class="text-xs text-gray-500 font-bold uppercase mb-1" id="label-term-2">Shorten to 25 Years</p>
<p class="text-lg font-black text-blue-600 mb-1" id="save-amount-2">--</p>
<p class="text-xs text-gray-500 mb-2">total savings</p>
<p class="text-xs text-gray-400" id="new-payment-2">New payment: --/mo</p>
<div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
<span class="text-xs text-blue-600 font-bold group-hover:underline flex items-center gap-1">Apply This <span class="group-hover:translate-x-1 transition-transform">‚Üí</span></span>
</div>
</div>

{/* Card 3: Bi-Weekly Payments */}
<div id="card-biweekly" class="advisor-card bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-transparent hover:border-purple-400 transition-all hover:shadow-lg cursor-pointer group">
<div class="flex items-start justify-between mb-2">
<span class="text-2xl">üîÑ</span>
<div class="flex items-center gap-1">
<span class="text-[10px] font-bold uppercase px-2 py-0.5 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-full">Low Effort</span>
<div class="tooltip-container relative">
<span class="tooltip-trigger w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 text-[10px] font-bold flex items-center justify-center cursor-help">?</span>
<div class="tooltip-content absolute right-0 top-6 w-56 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50 opacity-0 invisible transition-all">
<strong>Bi-Weekly Payments</strong><br/>Instead of 12 monthly payments, you make 26 half-payments per year. This equals 13 full monthly payments annually - one extra payment per year. This accelerates payoff without feeling the pinch.
</div>
</div>
</div>
</div>
<p class="text-xs text-gray-500 font-bold uppercase mb-1">Bi-Weekly Payments</p>
<p class="text-lg font-black text-purple-600 mb-1" id="save-amount-3">--</p>
<p class="text-xs text-gray-500 mb-2">saved in interest</p>
<p class="text-xs text-gray-400" id="save-time-3">Pay off -- years earlier</p>
<div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
<span class="text-xs text-purple-600 font-bold group-hover:underline flex items-center gap-1">Learn More <span class="group-hover:translate-x-1 transition-transform">‚Üí</span></span>
</div>
</div>

{/* Card 4: PMI Elimination (Conditional) */}
<div id="card-pmi" class="advisor-card hidden bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-transparent hover:border-orange-400 transition-all hover:shadow-lg cursor-pointer group">
<div class="flex items-start justify-between mb-2">
<span class="text-2xl">üõ°Ô∏è</span>
<div class="flex items-center gap-1">
<span class="text-[10px] font-bold uppercase px-2 py-0.5 bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300 rounded-full">Critical</span>
<div class="tooltip-container relative">
<span class="tooltip-trigger w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 text-[10px] font-bold flex items-center justify-center cursor-help">?</span>
<div class="tooltip-content absolute right-0 top-6 w-56 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50 opacity-0 invisible transition-all">
<strong>What is PMI?</strong><br/>Private Mortgage Insurance is required when your down payment is less than 20%. It protects the lender (not you) and typically costs 0.5-1% of the loan annually. Reaching 20% equity eliminates this extra cost.
</div>
</div>
</div>
</div>
<p class="text-xs text-gray-500 font-bold uppercase mb-1">Eliminate PMI</p>
<p class="text-lg font-black text-orange-600 mb-1" id="pmi-lump">--</p>
<p class="text-xs text-gray-500 mb-2">lump sum to remove PMI</p>
<p class="text-xs text-gray-400" id="pmi-monthly-save">Save --/mo in PMI</p>
<div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
<span class="text-xs text-orange-600 font-bold group-hover:underline flex items-center gap-1">Calculate Savings <span class="group-hover:translate-x-1 transition-transform">‚Üí</span></span>
</div>
</div>

</div>
</div>
)}

{/* Toast Notification */}
<div id="toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-5 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 max-w-sm">
<div class="flex items-start gap-3">
<span class="text-xl flex-shrink-0 mt-0.5">‚úì</span>
<span id="toast-message" class="text-sm leading-relaxed flex-1">Changes applied!</span>
<button id="toast-close" class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition-colors text-white font-bold text-sm">√ó</button>
</div>
</div>

{/* Amortization Table with Tabs */}
<div id="amortization-container" class="hidden bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden print:border print:block">
<div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center print:bg-white print:text-black">
<div class="flex gap-1">
<button id="tab-yearly" class="px-4 py-1.5 text-sm font-bold rounded-lg bg-green-600 text-white transition-all">Yearly</button>
<button id="tab-monthly" class="px-4 py-1.5 text-sm font-bold rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">Monthly</button>
</div>
<span class="text-sm font-medium text-gray-500 dark:text-gray-400">Amortization Schedule</span>
</div>
<div class="max-h-80 overflow-y-auto no-scrollbar print:max-h-none print:overflow-visible">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-gray-900 sticky top-0 print:static">
<tr>
<th id="col-period" class="px-4 py-2">Year</th>
<th class="px-4 py-2">Interest</th>
<th class="px-4 py-2">Principal</th>
<th class="px-4 py-2">Balance</th>
</tr>
</thead>
<tbody id="amortization-body" class="divide-y divide-gray-100 dark:divide-gray-800"></tbody>
</table>
</div>
</div>

</div>
</div>

<style>
.label { @apply block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1 uppercase tracking-wide; }
.input-field { @apply w-full px-3 py-2.5 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:ring-0 focus:border-green-500 bg-white dark:bg-gray-800 dark:text-white transition-colors outline-none font-bold text-gray-700; }
.input-with-currency { padding-left: 2.5rem; }
.currency-symbol { @apply absolute left-3 top-3 text-gray-400 text-sm font-bold pointer-events-none; }
.animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Tooltip Styles */
.tooltip-container:hover .tooltip-content {
  opacity: 1;
  visibility: visible;
}
.tooltip-content::before {
  content: '';
  position: absolute;
  top: -6px;
  right: 8px;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-bottom: 6px solid #111827;
}

@media print {
body * { visibility: hidden; }
#calc-form, #calc-form * { display: none !important; }
#smart-advisor { display: none !important; }
.print\:hidden { display: none !important; }

main, main * { visibility: visible; }
main { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
.lg\:col-span-7 { width: 100% !important; margin: 0 !important; }
}
</style>

<script is:inline define:vars={{ currentMonth, currentYear }}>
    let chartInstance;
    let yearlyAmortData = [];
    let monthlyAmortData = [];
    let activeTab = 'yearly';

    const formatNumber = (numStr) => {
        if (!numStr) return '';
        const clean = String(numStr).replace(/,/g, '').replace(/[^0-9.]/g, '');
        const parts = clean.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    };

    const cleanVal = (val) => {
        if (!val) return 0;
        return parseFloat(String(val).replace(/,/g, '')) || 0;
    };

    const fmt = (n) => n.toLocaleString('en-US', { maximumFractionDigits: 0 });

    let toastTimeout = null;
    
    const hideToast = () => {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.classList.add('translate-y-20', 'opacity-0');
            toast.classList.remove('translate-y-0', 'opacity-100');
        }
        if (toastTimeout) {
            clearTimeout(toastTimeout);
            toastTimeout = null;
        }
    };
    
    const showToast = (message) => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        if (toast && toastMessage) {
            if (toastTimeout) clearTimeout(toastTimeout);
            
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            toastTimeout = setTimeout(hideToast, 8000);
        }
    };

    const calculateLoan = (P, r, n, extraMonthly = 0) => {
        let balance = P;
        let totalInterest = 0;
        let totalPrincipal = 0;
        let months = 0;

        let monthlyPI = 0;
        if (r === 0) monthlyPI = P / n;
        else monthlyPI = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);

        const actualMonthly = monthlyPI + extraMonthly;

        while(balance > 0 && months < 1200) {
            const interest = balance * r;
            let principal = actualMonthly - interest;

            if (balance < principal) principal = balance;

            totalInterest += interest;
            totalPrincipal += principal;
            balance -= principal;
            months++;
        }
        return { totalInterest, totalPrincipal, months, monthlyPI, principal: P };
    };

    const calculateBiweekly = (P, rAnnual, originalMonths) => {
        const biweeklyRate = rAnnual / 26;
        const halfPayment = calculateLoan(P, rAnnual / 12, originalMonths).monthlyPI / 2;
        
        let balance = P;
        let totalInterest = 0;
        let periods = 0;
        
        while (balance > 0 && periods < 2000) {
            const interest = balance * biweeklyRate;
            let principal = halfPayment - interest;
            
            if (balance < principal) principal = balance;
            
            totalInterest += interest;
            balance -= principal;
            periods++;
        }
        
        const monthsToPayoff = Math.ceil(periods / 2.17);
        return { totalInterest, periods, monthsToPayoff, halfPayment };
    };

    const calculateGrowth = (P, r, t, contrib) => {
        const n = 12;
        const ratePerPeriod = r / n;
        const totalPeriods = t * n;

        const fvPrincipal = P * Math.pow(1 + ratePerPeriod, totalPeriods);
        const fvContrib = contrib * ((Math.pow(1 + ratePerPeriod, totalPeriods) - 1) / ratePerPeriod);

        const totalVal = fvPrincipal + fvContrib;
        const totalContrib = P + (contrib * totalPeriods);
        const interest = totalVal - totalContrib;

        return { totalVal, totalContrib, interest };
    };

    const getAmortizationData = (balance, rate, monthlyPayment, startYear, startMonth) => {
        let currentBalance = balance;
        let yearTotalInterest = 0;
        let yearTotalPrincipal = 0;
        let currentYear = startYear;
        let currentMonthVal = startMonth;
        const yearlyData = [];
        const monthlyData = [];
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        for (let i = 1; i <= 3600; i++) {
            if (currentBalance <= 0) break;
            const interestPayment = currentBalance * rate;
            let principalPayment = monthlyPayment - interestPayment;

            if (currentBalance < principalPayment) principalPayment = currentBalance;

            yearTotalInterest += interestPayment;
            yearTotalPrincipal += principalPayment;
            currentBalance -= principalPayment;

            monthlyData.push({
                period: monthNames[currentMonthVal - 1] + ' ' + currentYear,
                interest: interestPayment,
                principal: principalPayment,
                balance: Math.max(0, currentBalance)
            });

            currentMonthVal++;
            if (currentMonthVal > 12) {
                currentMonthVal = 1;
                yearlyData.push({
                    period: currentYear,
                    interest: yearTotalInterest,
                    principal: yearTotalPrincipal,
                    balance: Math.max(0, currentBalance)
                });
                yearTotalInterest = 0;
                yearTotalPrincipal = 0;
                currentYear++;
            }

            if (currentBalance <= 0 && yearTotalInterest > 0) {
                yearlyData.push({
                    period: currentYear,
                    interest: yearTotalInterest,
                    principal: yearTotalPrincipal,
                    balance: 0
                });
            }
        }
        return { yearlyData, monthlyData };
    };

    const renderAmortizationTable = (data) => {
        const tbody = document.getElementById('amortization-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        document.getElementById('amortization-container').classList.remove('hidden');

        data.forEach(row => {
            const html = '<tr class="bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700">' +
                '<td class="px-4 py-3 font-medium text-gray-900 dark:text-white">' + row.period + '</td>' +
                '<td class="px-4 py-3 text-red-500">' + Math.round(row.interest).toLocaleString() + '</td>' +
                '<td class="px-4 py-3 text-green-600">' + Math.round(row.principal).toLocaleString() + '</td>' +
                '<td class="px-4 py-3 text-gray-500">' + Math.round(row.balance).toLocaleString() + '</td>' +
                '</tr>';
            tbody.innerHTML += html;
        });
    };

    const switchTab = (tab) => {
        activeTab = tab;
        const tabYearly = document.getElementById('tab-yearly');
        const tabMonthly = document.getElementById('tab-monthly');
        const colPeriod = document.getElementById('col-period');

        if (tab === 'yearly') {
            tabYearly.classList.add('bg-green-600', 'text-white');
            tabYearly.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
            tabMonthly.classList.remove('bg-green-600', 'text-white');
            tabMonthly.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
            colPeriod.textContent = 'Year';
            renderAmortizationTable(yearlyAmortData);
        } else {
            tabMonthly.classList.add('bg-green-600', 'text-white');
            tabMonthly.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
            tabYearly.classList.remove('bg-green-600', 'text-white');
            tabYearly.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
            colPeriod.textContent = 'Month';
            renderAmortizationTable(monthlyAmortData);
        }
    };

    function renderChart(data, labels, colors) {
        const ctx = document.getElementById('myChart');
        const legend = document.getElementById('chart-legend');
        if (!ctx) return;

        if (chartInstance) chartInstance.destroy();
        
        const d = [], l = [], c = [];
        data.forEach((v, i) => { if(v > 0) { d.push(v); l.push(labels[i]); c.push(colors[i]); } });
        
        const total = d.reduce((a, b) => a + b, 0);
        const percentages = d.map(v => Math.round((v / total) * 100));
        
        if (legend) {
            legend.innerHTML = l.map((label, i) => 
                '<div class="flex items-center gap-1.5 bg-white dark:bg-gray-800 px-2 py-1 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">' +
                '<span class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ' + c[i] + '"></span>' +
                '<span class="text-gray-700 dark:text-gray-300 font-medium">' + label + '</span>' +
                '<span class="font-bold" style="color: ' + c[i] + '">' + percentages[i] + '%</span>' +
                '</div>'
            ).join('');
        }
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: l, datasets: [{ data: d, backgroundColor: c, borderWidth: 0, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, cutout: '65%' }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('calc-form');
        if (!form) return;

        const monthSelect = document.getElementById('input_month');
        const yearSelect = document.getElementById('input_year');
        if (monthSelect) monthSelect.value = String(currentMonth);
        if (yearSelect) yearSelect.value = String(currentYear);

        const currencySymbols = document.querySelectorAll('.currency-symbol');
        currencySymbols.forEach(sym => {
            const curr = sym.getAttribute('data-currency') || '';
            const input = sym.nextElementSibling;
            if (input && curr.length > 2) {
                input.style.paddingLeft = (curr.length * 10 + 16) + 'px';
            }
        });

        document.getElementById('tab-yearly')?.addEventListener('click', () => switchTab('yearly'));
        document.getElementById('tab-monthly')?.addEventListener('click', () => switchTab('monthly'));
        document.getElementById('toast-close')?.addEventListener('click', hideToast);

        function updateURL() {
            const params = new URLSearchParams();
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                if(input.value && input.type !== 'checkbox' && input.type !== 'submit') {
                    params.set(input.id, input.value);
                }
            });
            window.history.replaceState({}, '', location.pathname + '?' + params.toString());
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if(params.toString()) {
                params.forEach((val, key) => {
                    const el = document.getElementById(key);
                    if(el) el.value = val;
                });
                setTimeout(() => form.dispatchEvent(new Event('submit')), 100);
            }
        }

        const smartAdvisor = document.getElementById('smart-advisor');
        const toggleExtras = document.getElementById('toggle-extras');
        const extrasContainer = document.getElementById('extras-container');

        if(toggleExtras) {
            toggleExtras.addEventListener('change', (e) => {
                if (extrasContainer) {
                    extrasContainer.style.display = e.target.checked ? 'grid' : 'none';
                }
            });
        }

        document.querySelectorAll('.comma-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const target = e.target;
                if (target && 'value' in target) {
                    target.value = formatNumber(target.value);
                }
            });
        });

        document.getElementById('print-btn-action')?.addEventListener('click', () => window.print());

        document.getElementById('share-btn')?.addEventListener('click', () => {
             updateURL();
             navigator.clipboard.writeText(window.location.href);
             showToast("Link copied to clipboard!");
        });

        form.addEventListener('submit', () => updateURL());
        loadFromURL();

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const logic = form.dataset.logic;
            const currency = form.dataset.currency;
            const getVal = (id) => cleanVal(document.getElementById(id)?.value);

            document.getElementById('results-placeholder').classList.add('hidden');
            document.getElementById('results-header').classList.remove('hidden');
            document.getElementById('share-actions').classList.remove('hidden');
            
            // Only show details breakdown for loan/growth calculators
            const resultsDetails = document.getElementById('results-details');
            if (resultsDetails && ['loan', 'growth'].includes(logic)) {
                resultsDetails.classList.remove('hidden');
            }

            if (logic === 'loan') {
                let price = getVal('input_p');
                const down = getVal('extra_down') || getVal('input_down') || 0;
                const trade = getVal('extra_trade') || 0;
                const rAnnual = getVal('input_r');
                const r = rAnnual / 100 / 12;
                const years = getVal('input_t');
                const n = years * 12;
                const loanAmount = price - down - trade;

                const base = calculateLoan(loanAmount, r, n, 0);

                const extrasEnabled = document.getElementById('toggle-extras')?.checked;
                const monthlyTax = extrasEnabled ? getVal('extra_tax') / 12 : 0;
                const monthlyIns = extrasEnabled ? getVal('extra_ins') / 12 : 0;
                const monthlyHOA = extrasEnabled ? (getVal('extra_hoa') || 0) : 0;
                const totalExtrasMonthly = monthlyTax + monthlyIns + monthlyHOA;
                const totalMonthly = base.monthlyPI + totalExtrasMonthly;
                const totalPaid = (base.monthlyPI * n) + (totalExtrasMonthly * n);
                const totalExtrasOverLife = totalExtrasMonthly * n;

                const monthVal = document.getElementById('input_month')?.value || '1';
                const yearVal = document.getElementById('input_year')?.value || String(currentYear);
                const startDate = new Date(parseInt(yearVal), parseInt(monthVal) - 1, 1);
                const payoffDate = new Date(startDate);
                payoffDate.setMonth(startDate.getMonth() + base.months);

                document.getElementById('final-result').textContent = currency + totalMonthly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                document.getElementById('res-loan').textContent = currency + fmt(loanAmount);
                document.getElementById('res-interest').textContent = currency + fmt(base.totalInterest);
                
                const rowTaxes = document.getElementById('row-taxes');
                const resTax = document.getElementById('res-tax');
                if (totalExtrasMonthly > 0) {
                    if (rowTaxes) rowTaxes.classList.remove('hidden');
                    if (resTax) resTax.textContent = currency + fmt(totalExtrasOverLife);
                } else {
                    if (rowTaxes) rowTaxes.classList.add('hidden');
                }
                
                document.getElementById('res-total').textContent = currency + fmt(totalPaid);
                document.getElementById('res-date').textContent = payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                if (totalExtrasMonthly > 0) {
                    renderChart(
                        [loanAmount, base.totalInterest, totalExtrasOverLife], 
                        ['Principal', 'Interest', 'Taxes/Fees'], 
                        ['#3b82f6', '#ef4444', '#f97316']
                    );
                } else {
                    renderChart(
                        [loanAmount, base.totalInterest], 
                        ['Principal', 'Interest'], 
                        ['#3b82f6', '#ef4444']
                    );
                }

                const amortResult = getAmortizationData(loanAmount, r, base.monthlyPI, parseInt(yearVal), parseInt(monthVal));
                yearlyAmortData = amortResult.yearlyData;
                monthlyAmortData = amortResult.monthlyData;
                switchTab(activeTab);

                if (smartAdvisor) smartAdvisor.classList.remove('hidden');

                // Card 1: Extra $100/mo
                const sim1 = calculateLoan(loanAmount, r, n, 100);
                const save1 = base.totalInterest - sim1.totalInterest;
                const yearsSaved1 = Math.round((base.months - sim1.months) / 12 * 10) / 10;

                document.getElementById('save-amount-1').textContent = currency + fmt(save1);
                document.getElementById('save-time-1').textContent = 'Pay off ' + yearsSaved1 + ' years earlier';

                document.getElementById('card-extra')?.addEventListener('click', function handler(ev) {
                    ev.preventDefault();
                    showToast('Extra Payment Strategy: Pay ' + currency + '100 extra each month to save ' + currency + fmt(save1) + ' in interest and pay off your loan ' + yearsSaved1 + ' years earlier!');
                }, { once: true });

                // Card 2: Shorter Term
                const newYears = Math.max(1, years - 5);
                const sim2 = calculateLoan(loanAmount, r, newYears * 12, 0);
                const save2 = base.totalInterest - sim2.totalInterest;

                document.getElementById('label-term-2').textContent = 'Shorten to ' + newYears + ' Years';
                document.getElementById('save-amount-2').textContent = currency + fmt(save2);
                document.getElementById('new-payment-2').textContent = 'New payment: ' + currency + fmt(sim2.monthlyPI) + '/mo';

                document.getElementById('card-term')?.addEventListener('click', function handler(ev) {
                    ev.preventDefault();
                    document.getElementById('input_t').value = String(newYears);
                    form.dispatchEvent(new Event('submit'));
                    showToast('Loan term changed to ' + newYears + ' years. You\'ll save ' + currency + fmt(save2) + ' in interest! New payment: ' + currency + fmt(sim2.monthlyPI) + '/mo');
                }, { once: true });

                // Card 3: Bi-Weekly Payments
                const biweekly = calculateBiweekly(loanAmount, rAnnual / 100, n);
                const save3 = base.totalInterest - biweekly.totalInterest;
                const yearsSaved3 = Math.round((base.months - biweekly.monthsToPayoff) / 12 * 10) / 10;

                document.getElementById('save-amount-3').textContent = currency + fmt(save3);
                document.getElementById('save-time-3').textContent = 'Pay off ' + yearsSaved3 + ' years earlier';

                document.getElementById('card-biweekly')?.addEventListener('click', function handler(ev) {
                    ev.preventDefault();
                    showToast('Bi-Weekly Strategy: Pay ' + currency + fmt(biweekly.halfPayment) + ' every 2 weeks (26 payments/year = 13 monthly payments). Save ' + currency + fmt(save3) + ' and pay off ' + yearsSaved3 + ' years earlier!');
                }, { once: true });

                // Card 4: PMI Elimination (only if down < 20%)
                const downPercent = down / price;
                const cardPmi = document.getElementById('card-pmi');
                
                if (downPercent < 0.20 && cardPmi) {
                    cardPmi.classList.remove('hidden');
                    
                    const lumpNeeded = Math.max(0, (price * 0.20) - down);
                    const pmiRate = 0.008; // 0.8% annual PMI rate (industry average)
                    const monthlyPmi = (pmiRate * loanAmount) / 12;
                    
                    // Calculate months until LTV reaches 78% (when PMI auto-cancels)
                    const targetBalance = price * 0.78;
                    let pmiBalance = loanAmount;
                    let monthsWithPmi = 0;
                    while (pmiBalance > targetBalance && monthsWithPmi < n) {
                        const interest = pmiBalance * r;
                        const principal = base.monthlyPI - interest;
                        pmiBalance -= principal;
                        monthsWithPmi++;
                    }
                    
                    const totalPmiCost = monthlyPmi * monthsWithPmi;
                    const yearsWithPmi = Math.round(monthsWithPmi / 12 * 10) / 10;

                    document.getElementById('pmi-lump').textContent = currency + fmt(lumpNeeded);
                    document.getElementById('pmi-monthly-save').textContent = 'Save ' + currency + fmt(monthlyPmi) + '/mo in PMI';

                    cardPmi.addEventListener('click', function handler(ev) {
                        ev.preventDefault();
                        showToast('PMI Elimination: Add ' + currency + fmt(lumpNeeded) + ' to your down payment to reach 20% equity and skip PMI entirely. Otherwise you\'ll pay ' + currency + fmt(monthlyPmi) + '/mo PMI for ~' + yearsWithPmi + ' years (' + currency + fmt(totalPmiCost) + ' total).');
                    }, { once: true });
                } else if (cardPmi) {
                    cardPmi.classList.add('hidden');
                }
            }
            else if (logic === 'growth') {
                const P = getVal('input_p');
                const r = getVal('input_r') / 100;
                const t = getVal('input_t');
                const contrib = getVal('extra_contrib') || 0;
                const growth = calculateGrowth(P, r, t, contrib);

                document.getElementById('final-result').textContent = currency + fmt(growth.totalVal);
                document.getElementById('res-loan').textContent = currency + fmt(growth.totalContrib);
                document.getElementById('res-interest').textContent = currency + fmt(growth.interest);
                document.getElementById('res-total').textContent = currency + fmt(growth.totalVal);

                renderChart([growth.totalContrib, growth.interest], ['Contributions', 'Interest Earned'], ['#3b82f6', '#10b981']);
            }
            else {
                const v1 = getVal('input_v1') || getVal('input_p');
                const v2 = getVal('input_v2');
                let res = 0;
                if (logic === 'roi') res = ((v2 - v1) / v1) * 100;
                if (logic === 'profit') res = ((v2 - v1) / v2) * 100;
                if (logic === 'percentage') res = v1 * (v2/100);
                if (logic === 'simple_diff') res = v1 - v2;

                let resStr = res.toLocaleString('en-US', { minimumFractionDigits: 2 });
                if (['roi', 'profit'].includes(logic)) resStr += "%";
                else resStr = currency + resStr;
                document.getElementById('final-result').textContent = resStr;
            }
        });
    });
</script>
